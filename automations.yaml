# Automations
# TODO: Cleanup code.

# Turn of electrical blanket after 1,5 hours.
- id: e36d70363e714edca940cdd31d3b3ea7
  alias: ElectrischeDekenUit
  trigger:
  - entity_id: switch.electrische_deken
    for: 01:30:00
    from: 'off'
    platform: state
    to: 'on'
  action:
  - entity_id: switch.electrische_deken
    service: switch.turn_off

# Turn central heating on when someone comes home
- id: 90dadca3afd449f1b86bc92904ffa006
  alias: VerwarmingAan
  trigger:
  - entity_id: group.people
    from: not_home
    platform: state
    to: home
  condition:
  - after: '7:00'
    before: '21:59'
    condition: time
  action:
  - data:
      entity_id: climate.downstairs
      preset_mode: none
    service: climate.set_preset_mode
  - data:
      entity_id: climate.downstairs
      hvac_mode: heat
    service: climate.set_hvac_mode
  - data:
      entity_id: climate.downstairs
      temperature: 19
    service: climate.set_temperature

# Turn central heating and livingroom lights off when last person leaves home
- alias: VerwarmingUit
  trigger:
    platform: state
    entity_id: group.people
    from: home
    to: not_home
  action:
  - service: climate.set_preset_mode
    data:
      entity_id: climate.downstairs
      preset_mode: away
  - service: homeassistant.turn_off
    data:
      entity_id: group.woonkamer_groep
  id: 45cb90b5728f4866b783af601e9f497a

# Turn livingroom lights on 1 hour before sunset
# TODO: Combine with ligth sensor and current state of ligths
- alias: woonkmrLampenAan
  trigger:
    platform: sun
    event: sunset
    offset: -01:00:00
  condition:
  - condition: state
    entity_id: group.people
    state: home
  action:
  - service: homeassistant.turn_on
    data:
      entity_id: group.woonkamer_groep
  id: ee4548b0219c4215b3ce51e7e0442aed

# Ipad needs charging, send notification
- id: '1547220645338'
  alias: iPad opladen
  trigger:
  - below: '15'
    entity_id: sensor.ipad_van_fabian_battery_level
    platform: numeric_state
  condition: []
  action:
  - data:
      message: iPad batterij onder 15%, opladen!
    service: notify.ios_fabian

# Washing machine finished, send notification
# TODO: change notification Myrthe to Android phone.
- id: '1547221368193'
  alias: Wasmachine klaar
  trigger:
  - below: '10'
    entity_id: sensor.wasmachine_energie_verbruik
    for: 00:05:00
    platform: numeric_state
  condition:
  - condition: state
    entity_id: switch.wasmachine
    state: 'on'
  action:
  - data:
      message: Wasmachine is klaar!!
    service: notify.ios_fabian
  - data:
      message: Wasmachine is klaar!!
    service: notify.ios_myrthe

# 3d printer finished, send notification
- id: '1549731767373'
  alias: 3d Printer klaar
  trigger:
  - entity_id: sensor.3d_printer_current_state
    from: Printing
    platform: state
    to: Operational
  condition: []
  action:
  - data:
      message: 3d Printer is klaar!!
    service: notify.ios_fabian

# Turn on central heating 2 hours before first person has to go to work when people home.
# TODO: check for the individual person to be home.
- id: '1550777256941'
  alias: VerwarmingAanKalender
  trigger:
  - platform: template
    value_template: '{% set work_start = ( [states.calendar.werk_rooster_fabian.attributes.start_time,states.calendar.werk_rooster_myrthe.attributes.start_time]
      | min ) %} {% set work_time = strptime(work_start,"%Y-%m-%d %H:%M:%S") %} {%
      set heat_time = work_time.replace(hour=work_time.hour-2) %} {{ strptime(states.sensor.date_time.state,
      "%Y-%m-%d, %H:%M") == heat_time }}'
  condition:
  - condition: state
    entity_id: group.people
    state: home
  action:
  - data:
      entity_id: automation.verwarmingaan
    service: automation.trigger
